#!/bin/sh

# F<digit><digit><whatever-else-you-want> is executed just before
# user logs in, or program starts executing, after chroot is created
# in --login or --execute target.

# Use local results of previous builds - not needed (yet)
#cd /var/cache/pbuilder/result/
#/usr/bin/dpkg-scanpackages . /dev/null >> /var/cache/pbuilder/result/Packages

# Since Debian/stretch, gnupg is not an apt dependency anymore, leading apt-key add to fail
apt-get -y install gnupg

<% if @backports == true then -%>
# Backports
echo "deb http://backports.debian.org/debian-backports/ <%= @release %>-backports main" >> /etc/apt/sources.list

<% end -%>

<% if @nodesource == true then -%>
# Nodesource
echo "deb http://deb.nodesource.com/node_10.x <%= @release %> main" >> /etc/apt/sources.list

cat <<EOF | apt-key add -
-----BEGIN PGP PUBLIC KEY BLOCK-----
Version: GnuPG v1
Comment: GPGTools - https://gpgtools.org

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
=CLGF
-----END PGP PUBLIC KEY BLOCK-----
EOF
<% end -%>

<% if @puppetlabs == true then %>
# Puppet5
echo "deb http://apt.puppet.com <%= @release %> puppet5" >> /etc/apt/sources.list

cat <<EOF | apt-key add -
-----BEGIN PGP PUBLIC KEY BLOCK-----

mQINBFe2Iz4BEADqbv/nWmR26bsivTDOLqrfBEvRu9kSfDMzYh9Bmik1A8Z036Eg
h5+TZD8Rrd5TErLQ6eZFmQXk9yKFoa9/C4aBjmsL/u0yeMmVb7/66i+x3eAYGLzV
FyunArjtefZyxq0B2mdRHE8kwl5XGl8015T5RGHCTEhpX14O9yigI7gtliRoZcl3
hfXtedcvweOf9VrV+t5LF4PrZejom8VcB5CE2pdQ+23KZD48+Cx/sHSLHDtahOTQ
5HgwOLK7rBll8djFgIqP/UvhOqnZGIsg4MzTvWd/vwanocfY8BPwwodpX6rPUrD2
aXPsaPeM3Q0juDnJT03c4i0jwCoYPg865sqBBrpOQyefxWD6UzGKYkZbaKeobrTB
xUKUlaz5agSK12j4N+cqVuZUBAWcokXLRrcftt55B8jz/Mwhx8kl6Qtrnzco9tBG
T5JN5vXMkETDjN/TqfB0D0OsLTYOp3jj4hpMpG377Q+6D71YuwfAsikfnpUtEBxe
NixXuKAIqrgG8trfODV+yYYWzfdM2vuuYiZW9pGAdm8ao+JalDZss3HL7oVYXSJp
MIjjhi78beuNflkdL76ACy81t2TvpxoPoUIG098kW3xd720oqQkyWJTgM+wV96bD
ycmRgNQpvqHYKWtZIyZCTzKzTTIdqg/sbE/D8cHGmoy0eHUDshcE0EtxsQARAQAB
tEhQdXBwZXQsIEluYy4gUmVsZWFzZSBLZXkgKFB1cHBldCwgSW5jLiBSZWxlYXNl
IEtleSkgPHJlbGVhc2VAcHVwcGV0LmNvbT6JAj4EEwECACgFAle2Iz4CGwMFCQlm
AYAGCwkIBwMCBhUIAgkKCwQWAgMBAh4BAheAAAoJEH9DgoDvjTSfIN0P/jcCRzK8
WIdhcNz5dkj7xRZb8Oft2yDfenQmzb1SwGGa96IwJFcjF4Nq7ymcDUqunS2DEDb2
gCucsqmW1ubkaggsYbc9voz/SQwhsQpBjfWbuyOX9DWmW6av/aB1F85wP79gyfqT
uidTGxQE6EhDbLe7tuvxOHfM1bKsUtI+0n9TALLLHfXUEdtaXCwMlJuO1IIn1PWa
H7HzyEjw6OW/cy73oM9nuErBIio1O60slPLOW2XNhdWZJCRWkcXyuumRjoepz7WN
1JgsLOTcB7rcQaBP3pDN0O/Om5dlDQ6oYitoJs/F0gfEgwK68Uy8k8sUR+FLLJqM
o0CwOg6CeWU4ShAEd1xZxVYW6VOOKlz9x9dvjIVDn2SlTBDmLS99ySlQS57rjGPf
GwlRUnuZP4OeSuoFNNJNb9PO6XFSP66eNHFbEpIoBU7phBzwWpTXNsW+kAcY8Rno
8GzKR/2FRsxe5Nhfh8xy88U7BA0tqxWdqpk/ym+wDcgHBfSRt0dPFnbaHAiMRlgX
J/NPHBQtkoEdQTKA+ICxcNTUMvsPDQgZcU1/ViLMN+6kZaGNDVcPeMgDvqxu0e/T
b3uYiId38HYbHmD6rDrOQL/2VPPXbdGbxDGQUgX1DfdOuFXw1hSTilwI1KdXxUXD
sCsZbchgliqGcI1l2En62+6pI2x5XQqqiJ7+
=HpaX
-----END PGP PUBLIC KEY BLOCK-----
EOF
<% end -%>

# Get the Foreman GPG key, just in case we've added the repo
# in an earlier hook (via Jenkins, say). Sadly wget is not available in
# pbuilder image, so this is a bit hacky...
cat <<EOF | apt-key add -
-----BEGIN PGP PUBLIC KEY BLOCK-----
Version: GnuPG v2.0.22 (GNU/Linux)

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
=J97K
-----END PGP PUBLIC KEY BLOCK-----
EOF

# Update apt
/usr/bin/apt-get update
