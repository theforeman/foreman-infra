- job:
    name: test_proxy_plugin_matrix
    description: >
      Tests the main branch of an individual smart proxy plugin.
    concurrent: true
    project-type: matrix
    logrotate:
      daysToKeep: 45
      numToKeep: -1
    parameters:
      - string:
          name: plugin_repo
      - string:
          name: plugin_branch
          default: master
      - string:
          name: plugin_name
      - bool:
          name: min_ruby200
          default: true
          description: >
            Enable if Ruby 2.0.0 is the minimum Ruby version and lower versions will be skipped. Recommended for 1.14 onwards.
    scm:
      - git:
          url: '${plugin_repo}'
          name: plugin
          wipe-workspace: true
          prune: true
          branches:
            - 'plugin/${plugin_branch}'
    axes:
      - axis:
          type: user-defined
          name: ruby
          values:
            - '1.8.7'
            - '1.9.3'
            - '2.0.0'
            - '2.1'
            - '2.2'
            - '2.3'
            - '2.4'
    execution-strategy:
      combination-filter: '(min_ruby200 == "true" && ruby ==~ /2.*/) || min_ruby200 != "true"'
    wrappers:
      - timeout:
          type: absolute
          abort: true
          timeout: 60
          timeout-var: 'BUILD_TIMEOUT'
          write-description: 'Build timed out (after ${BUILD_TIMEOUT} minutes). Marking the build as aborted.'
    builders:
      - shell: !include-raw: scripts/test/test_proxy_plugin_matrix.sh
    publishers:
      - gemset_cleanup
