- job:
    name: test_kafo_parsers_master_pull_request
    description: |
      Tests a Kafo Parsers pull request under each Ruby and Puppet configuration.
    concurrent: true
    logrotate:
      daysToKeep: 45
      numToKeep: -1
    properties:
      - github:
          url: https://github.com/theforeman/kafo_parsers
    parameters:
      - pr_parameters
    scm:
      - git:
          url: https://github.com/theforeman/kafo_parsers
          per-build-tag: true
          wipe-workspace: true
          branches:
            - '${ghprbActualCommit}'
          refspec: '+refs/pull/${ghprbPullId}/*:refs/remotes/origin/pr/${ghprbPullId}/*'
    triggers:
      - github_pr:
          context: kafo
    axes:
      - axis:
          type: user-defined
          name: ruby
          values:
            - 1.8.7
            - 1.9.3
            - 2.0.0
            - 2.1
            - 2.2
            - 2.3
      - axis:
          type: user-defined
          name: puppet
          values:
            - 2.7.0
            - 3.0.0
            - 3.1.0
            - 3.2.0
            - 3.3.0
            - 3.4.0
            - 3.5.0
            - 3.6.0
            - 3.7.0
            - 3.8.0
            - 4.0.0
            - 4.1.0
            - 4.2.0
            - 4.3.0
            - 4.4.0
    execution-strategy:
      combination-filter: |
        !( (ruby ==~ /(1\.9|2).*/ && puppet ==~ /2\.6.*/) || (ruby ==~ /2.*/ && puppet ==~ /(2|3\.[01]).*/) || (ruby ==~ /2\.[^0]*/ && puppet ==~ /(2|3\.[0-4]).*/) || (ruby ==~ /2\.[2-9].*/ && puppet ==~ /(2|3).*/) || (ruby ==~ /1\.(8|9).*/ && puppet ==~ /4\..*/) || (ruby ==~ /2\.[3-9].*/ && puppet ==~ /4\.[0-3].*/) )
      touchstone:
        expr: |
          ruby=="2.0.0" && puppet=="3.3.0"
        result: stable
    builders:
      - shell: !include-raw: scripts/test/test_kafo_parsers_master.sh
    publishers:
      - gemset_cleanup
      - junit:
          results: 'jenkins/reports/unit/*.xml'
          health-scale-factor: 1.0
