- job:
    name: test_plugin_pull_request_temp
    description: |
      Tests a pull request for an individual plugin.
    concurrent: true
    project-type: matrix
    node: fast
    logrotate:
      daysToKeep: 30
      numToKeep: -1
    parameters:
      - pr_parameters
      - string:
          name: plugin_repo
          description: >
            Git URL containing the Foreman plugin, e.g. <pre>https://github.com/theforeman/foreman_example</pre>
      - string:
          name: plugin_branch
          default: master
          description: >
            Git branch name of the Foreman plugin, e.g. <pre>master</pre>
      - string:
          name: plugin_name
          description: >
            Name of the Foreman plugin/gem, in the format that should be in the Gemfile, e.g. <pre>foreman_test</pre>
      - string:
          name: foreman_repo
          default: https://github.com/theforeman/foreman
          description: >
            Git URL containing Foreman itself, which the plugin will be added to, e.g. <pre>https://github.com/theforeman/foreman</pre>
      - string:
          name: foreman_branch
          default: develop
          description: >
            Git branch name of Foreman itself, e.g. <pre>develop</pre>
    scm:
      - git:
          url: '${foreman_repo}'
          prune: true
          wipe-workspace: true
          basedir: 'foreman'
          branches:
            - 'upstream/${foreman_branch}' # this seems weird?
    axes:
      - axis:
          type: user-defined
          name: ruby
          values:
            - 2.3
            - 2.4
            - 2.5
      - axis:
          type: user-defined
          name: database
          values:
            - postgresql
            - sqlite3
            - mysql
    execution-strategy:
      combination-filter: >
        ((database == 'postgresql') && ((ruby == '2.3') || (ruby == '2.4') || (ruby == '2.5'))) || ((database == 'mysql') && (ruby == '2.4')) || ((database == 'sqlite3') && (ruby == '2.4'))
    wrappers:
      - timeout:
          type: absolute
          abort: true
          timeout: 120
          timeout-var: 'BUILD_TIMEOUT'
          write-description: 'Build timed out (after ${BUILD_TIMEOUT} minutes). Marking the build as aborted.'
    builders:
      - shell: !include-raw: scripts/test/test_plugin_pull_request.sh
    publishers:
      - gemset_cleanup
      - junit:
          results: 'foreman/jenkins/reports/unit/*.xml'
      - trigger-parameterized-builds:
          - project: pull_request_scanner
            condition: ALWAYS
            predefined-parameters: |
              project=${plugin_name}
              pr_number=${pr_number}
